<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Earth 3D</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; overflow: hidden; background: black; }
        #cesiumContainer { width: 100%; height: 100vh; margin: 0; padding: 0; overflow: hidden; }

        /* --- ä»‹é¢é¢¨æ ¼ï¼šæ¨¡ä»¿ Radio Garden æ¥µç°¡é»‘é€ --- */
        
        /* 1. é ‚éƒ¨æ’­æ”¾å™¨ */
        #radio-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 170, 0.3);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box;
            z-index: 100; color: white;
        }
        .station-info { display: flex; flex-direction: column; }
        .station-name { font-size: 18px; font-weight: bold; color: #00ffaa; text-shadow: 0 0 10px #00ffaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .station-country { font-size: 12px; color: #ccc; letter-spacing: 1px; }
        audio { height: 30px; max-width: 150px; filter: invert(1); } /* åè½‰é¡è‰²è®“æ’­æ”¾å™¨è®Šé»‘ */

        /* 2. èŠå¤©é¢æ¿ */
        #chat-panel {
            position: fixed; top: 90px; left: 20px;
            width: 300px; height: 50vh;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 170, 0.3);
            border-radius: 10px;
            padding: 10px; color: #ddd;
            display: flex; flex-direction: column;
            z-index: 100; backdrop-filter: blur(5px);
            transition: all 0.3s;
        }
        #chat-panel.minimized { height: 40px; overflow: hidden; background: rgba(0,0,0,0.8); }
        
        #panel-header { display: flex; justify-content: space-between; cursor: pointer; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;}
        #panel-title { color: #fff; font-weight: bold; }
        #chat-history { flex: 1; overflow-y: auto; font-size: 13px; scrollbar-width: thin; }
        .msg { margin-bottom: 5px; }
        .msg-name { color: #00ffaa; font-weight: bold; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        
        #input-area { display: flex; gap: 5px; margin-top: 5px; }
        #msg-input { flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px; border-radius: 4px; }
        
        /* 3. ä¸­å¿ƒåå­—æº–å¿ƒ */
        #crosshair {
            position: fixed; top: 50%; left: 50%; width: 20px; height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 90; pointer-events: none;
        }

        /* 4. è®€å–æç¤º */
        #loading-badge {
            position: fixed; bottom: 20px; right: 20px;
            color: #00ffaa; font-size: 12px; z-index: 100;
            text-shadow: 0 0 5px black; background: rgba(0,0,0,0.5);
            padding: 5px 10px; border-radius: 10px; border: 1px solid #00ffaa;
        }

        .cesium-viewer-bottom { display: none; } /* éš±è—ç‰ˆæ¬Šå­—æ¨£ */

        @media (max-width: 768px) {
            #chat-panel { top: auto; bottom: 0; left: 0; width: 100%; height: 35vh; border-radius: 15px 15px 0 0; }
            #radio-player-bar { height: 60px; }
            audio { max-width: 100px; }
        }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div id="crosshair"></div>

    <div id="radio-player-bar">
        <div class="station-info">
            <div class="station-name" id="current-station">Radio Earth 3D</div>
            <div class="station-country" id="current-country">è¼‰å…¥å…¨çƒè¨Šè™Ÿä¸­...</div>
        </div>
        <audio id="audio-player" controls autoplay playsinline></audio>
    </div>

    <div id="loading-badge">ğŸ“¡ æ­£åœ¨åˆå§‹åŒ– 3D å¼•æ“...</div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸ“¡ å…¨çƒè¨Šè™Ÿ <span id="gps-status" style="font-size:10px;color:#aaa;">(å®šä½ä¸­)</span></div>
            <div style="color:#00ffaa;">â–¼</div>
        </div>
        <div id="profile-section" style="margin-bottom:5px; display:flex; gap:5px;">
            <input type="text" id="name-input" placeholder="åå­—" style="flex:1; background:#333; border:none; color:white; padding:4px;">
            <button id="update-name-btn" style="background:#007bff; color:white; border:none; cursor:pointer;">æ”¹å</button>
        </div>
        <div id="chat-history">
            <div class="msg-sys">æ­¡è¿ä¾†åˆ° 3D å»£æ’­ä¸–ç•Œã€‚</div>
            <div class="msg-sys">æ··åˆè¼‰å…¥æ¨¡å¼ï¼šå…¨çƒç†±é–€ + å°ç£å…¨é »é“ã€‚</div>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            if (isMinimized) { panel.classList.remove('minimized'); isMinimized = false; } 
            else { panel.classList.add('minimized'); isMinimized = true; }
        }

        // --- 1. åˆå§‹åŒ– Cesium 3D åœ°çƒ ---
        var viewer = new Cesium.Viewer('cesiumContainer', {
            // ä½¿ç”¨å…§å»ºçš„æ·±è‰²è¡›æ˜Ÿåœ–ï¼Œæ›´æœ‰è³ªæ„Ÿ (NaturalEarthII)
            imageryProvider: new Cesium.TileMapServiceImageryProvider({
                url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII"),
            }),
            baseLayerPicker: false, geocoder: false, homeButton: false, infoBox: false,
            sceneModePicker: false, selectionIndicator: false, timeline: false,
            navigationHelpButton: false, animation: false, scene3DOnly: true,
            contextOptions: { webgl: { alpha: true } }
        });

        // é–‹å•Ÿè¿·éœ§èˆ‡æ—¥ç…§ï¼Œå¢åŠ çœŸå¯¦æ„Ÿ
        viewer.scene.fog.enabled = true;
        viewer.scene.fog.density = 0.0002;
        viewer.scene.globe.enableLighting = true;
        
        // ä½¿ç”¨ PointPrimitiveCollection é«˜æ•ˆèƒ½ç¹ªåœ– (é©åˆå¤§é‡é»)
        var pointCollection = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection());
        
        // --- 2. æ··åˆè¼‰å…¥ç­–ç•¥ (å…¨çƒ + å°ç£) ---
        async function loadHybridStations() {
            var badge = document.getElementById('loading-badge');
            badge.innerText = "æ­£åœ¨ä¸‹è¼‰å…¨çƒç†±é–€é›»å° (1/2)...";

            var allStations = [];
            var seenIds = new Set();

            // æ­¥é©Ÿ A: æŠ“å…¨çƒç†±é–€ 3500 å° (æ’å ´é¢)
            try {
                // ä¸é™ HTTPSï¼Œå› ç‚ºæˆ‘å€‘æœ‰ Proxy
                let res = await fetch("https://de1.api.radio-browser.info/json/stations/search?limit=3500&hidebroken=true&has_geo_info=true&order=clickcount&reverse=true");
                let globalData = await res.json();
                globalData.forEach(s => {
                    if(!seenIds.has(s.stationuuid)) {
                        allStations.push(s);
                        seenIds.add(s.stationuuid);
                    }
                });
            } catch(e) { console.log("å…¨çƒè¼‰å…¥å¤±æ•—", e); }

            // æ­¥é©Ÿ B: å¼·åˆ¶æŠ“å°ç£é›»å° (è£œå¼·)
            badge.innerText = "æ­£åœ¨è£œå¼·å°ç£è¨Šè™Ÿ (2/2)...";
            try {
                let res = await fetch("https://de1.api.radio-browser.info/json/stations/bycountrycodeexact/TW?hidebroken=true");
                let twData = await res.json();
                twData.forEach(s => {
                    // å¦‚æœå…¨çƒç†±é–€è£¡æ²’æœ‰ï¼Œå°±åŠ é€²å»
                    if(!seenIds.has(s.stationuuid)) {
                        // å¦‚æœå°ç£é›»å°æ²’åº§æ¨™ï¼Œéš¨æ©Ÿæ’’åœ¨å°ç£ä¸Šç©º
                        if (!s.geo_lat || !s.geo_long) {
                            s.geo_lat = 23.5 + (Math.random() - 0.5) * 2;
                            s.geo_long = 121 + (Math.random() - 0.5) * 1.5;
                        }
                        allStations.push(s);
                        seenIds.add(s.stationuuid);
                    }
                });
            } catch(e) { console.log("å°ç£è¼‰å…¥å¤±æ•—", e); }

            badge.innerText = `è™•ç†ä¸­... å…± ${allStations.length} å€‹è¨Šè™Ÿ`;

            // æ­¥é©Ÿ C: ç•«åˆ°åœ°çƒä¸Š
            allStations.forEach(station => {
                if (station.geo_lat && station.geo_long) {
                    var p = pointCollection.add({
                        position: Cesium.Cartesian3.fromDegrees(station.geo_long, station.geo_lat),
                        pixelSize: 5, // é»çš„å¤§å°
                        color: Cesium.Color.fromCssColorString('#00ffaa'), // è¢å…‰ç¶ 
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1,
                        // è¨­å®šå¯è¦‹è·é›¢èˆ‡åŠé€æ˜æ•ˆæœ
                        translucencyByDistance: new Cesium.NearFarScalar(1.5e2, 1.0, 1.5e7, 0.4),
                        disableDepthTestDistance: 5000000
                    });
                    // ç¶å®šè³‡æ–™ ID åˆ°é€™å€‹é»
                    p.id = station; 
                }
            });

            badge.innerText = "è¨Šè™Ÿæƒæå®Œæˆ âœ…";
            setTimeout(() => badge.style.display = 'none', 3000);
            document.getElementById('current-country').innerText = "è«‹é»æ“Šç¶ è‰²å…‰é»æ”¶è½";
        }

        loadHybridStations();

        // --- 3. é»æ“Šé›»å°æ’­æ”¾ ---
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(click) {
            var pickedObject = viewer.scene.pick(click.position);
            
            // æª¢æŸ¥é»åˆ°çš„æ˜¯ä¸æ˜¯é›»å°é»é»
            if (Cesium.defined(pickedObject) && pickedObject.primitive === pointCollection) {
                var station = pickedObject.id; // å–å‡ºç¶å®šçš„è³‡æ–™
                playRadio(station.name, station.country, station.url_resolved);
                
                // é¡é ­é£›å‘è©²é›»å° (åƒ Radio Garden ä¸€æ¨£)
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(station.geo_long, station.geo_lat, 500000), // é«˜åº¦ 500km
                    duration: 1.5
                });
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        function playRadio(name, country, url) {
            var player = document.getElementById('audio-player');
            var finalUrl = url;
            
            // ğŸ”¥ è‡ªå‹• Proxy åˆ¤æ–·ï¼šå¦‚æœæ˜¯ HTTPï¼Œå°±èµ°æˆ‘å€‘çš„ä¼ºæœå™¨
            if (url.startsWith('http://')) {
                finalUrl = '/radio-proxy?url=' + encodeURIComponent(url);
            }
            
            player.src = finalUrl;
            document.getElementById('current-station').innerText = "é€£ç·šä¸­... " + name;
            
            player.play().then(() => {
                document.getElementById('current-station').innerText = name;
                document.getElementById('current-country').innerText = country;
            }).catch(() => {
                document.getElementById('current-station').innerText = "âŒ è¨Šè™Ÿä¸­æ–·";
                document.getElementById('current-country').innerText = "è©²é›»å°æš«æ™‚ç„¡æ³•é€£ç·š";
            });
        }

        // --- 4. ç©å®¶ GPS èˆ‡å¤šäººé€£ç·š ---
        var playerEntities = {}; 
        var myEntity = null;

        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    document.getElementById('gps-status').innerText = "(è¨Šè™Ÿè‰¯å¥½)";

                    if (!myEntity) {
                        // ç¬¬ä¸€æ¬¡å®šä½ï¼Œé£›åˆ°å°ç£ä¸Šç©º
                        viewer.camera.flyTo({
                            destination : Cesium.Cartesian3.fromDegrees(lng, lat, 3000000) 
                        });
                        initConnection(lat, lng);
                        myEntity = true;
                    } else {
                        socket.emit('playerMove', { lat: lat, lng: lng });
                    }
                }, (err) => {
                    document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)";
                    initConnection(25.03, 121.56);
                }, { enableHighAccuracy: true });
            } else {
                initConnection(25.03, 121.56);
            }
        };

        function initConnection(lat, lng) { socket.emit('reportLocation', { lat: lat, lng: lng }); }
        
        socket.on('yourNameIs', function(name) { document.getElementById('name-input').value = name; });
        function updateName() { var n=document.getElementById('name-input').value; if(n.trim()) socket.emit('changeName', n); }
        document.getElementById('update-name-btn').addEventListener('click', updateName);

        // æ›´æ–°å…¶ä»–ç©å®¶ä½ç½®
        socket.on('updateMap', function(users) {
            var activeIds = new Set();
            for (var id in users) {
                activeIds.add(id);
                var u = users[id];
                if (playerEntities[id]) {
                    playerEntities[id].position = Cesium.Cartesian3.fromDegrees(u.lng, u.lat);
                    playerEntities[id].label.text = u.name;
                } else {
                    // å»ºç«‹æ–°ç©å®¶ (é’è‰²é»)
                    playerEntities[id] = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(u.lng, u.lat),
                        point: { 
                            pixelSize: 10, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.BLACK, outlineWidth: 2, 
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND 
                        },
                        label: { 
                            text: u.name, font: '14px sans-serif', fillColor: Cesium.Color.CYAN, 
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE, pixelOffset: new Cesium.Cartesian2(0, -15), 
                            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, 2000000.0) 
                        }
                    });
                }
            }
            // ç§»é™¤æ–·ç·šç©å®¶
            for (var existingId in playerEntities) {
                if (!activeIds.has(existingId)) { viewer.entities.remove(playerEntities[existingId]); delete playerEntities[existingId]; }
            }
        });

        socket.on('history', function(h) { 
            var b = document.getElementById('chat-history');
            h.forEach(d => {
                b.innerHTML += `<div class="msg"><span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}${d.text}</span></div>`;
            });
            b.scrollTop = b.scrollHeight;
        });

        socket.on('chatMessage', function(d) {
            var b = document.getElementById('chat-history');
            b.innerHTML += `<div class="msg"><span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}${d.text}</span></div>`;
            b.scrollTop = b.scrollHeight;
        });

        var input = document.getElementById('msg-input');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && input.value.trim()) {
                socket.emit('sendChat', input.value);
                input.value = "";
            }
        });
    </script>
</body>
</html>