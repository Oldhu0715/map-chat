<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨çƒå³æ™‚é€šè¨Š (å–®ä¸€ä¸–ç•Œç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #222; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #0a0a0a; /* èƒŒæ™¯æ”¹æ·±é»‘ï¼Œé…åˆåœ°åœ–é‚Šç•Œ */ }

        /* å·¦å´æ‡¸æµ®é¢æ¿ */
        #chat-panel {
            position: fixed; top: 20px; left: 20px;
            width: 320px; height: 60vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 15px;
            color: #ddd;
            display: flex; flex-direction: column;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 234, 0.2);
        }

        #profile-section { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        #name-input { flex: 1; padding: 5px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; }
        #update-name-btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; }

        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 14px; }
        .msg { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .msg-name { color: #00ffea; font-weight: bold; font-size: 13px; }
        .msg-text { color: white; margin-top: 2px; }
        .msg-sys { color: #888; font-style: italic; font-size: 12px; }
        
        .gps-info { font-size: 11px; color: #f39c12; margin-top: 5px; }
        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 10px; border: none; border-radius: 4px; background: #333; color: white; }
        
        /* æ¨£å¼ */
        .user-label {
            background-color: #000000; color: #00ffea; border: 2px solid #00ffea;
            font-size: 13px; font-weight: 900; padding: 3px 8px; border-radius: 4px;
            white-space: nowrap; box-shadow: 0 0 5px #00ffea; text-align: center;
        }
        .leaflet-popup-content-wrapper { background: rgba(0,0,0,0.9); color: white; border: 1px solid #00ffea; }
        .leaflet-popup-tip { background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>

    <div id="world-map"></div>

    <div id="chat-panel">
        <div style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 5px;">
            ğŸŒ å…¨çƒè¨Šè™Ÿç«™
        </div>

        <div id="profile-section">
            <div style="font-size: 12px; color: #aaa;">æˆ‘çš„åå­—ï¼š</div>
            <div class="input-group">
                <input type="text" id="name-input" placeholder="è¼¸å…¥æ–°åå­—...">
                <button id="update-name-btn">æ”¹å</button>
            </div>
            <div id="gps-status" class="gps-info">æ­£åœ¨æ ¡æ­£è¡›æ˜Ÿè¨Šè™Ÿ...</div>
        </div>

        <div id="chat-history">
            <div class="msg-sys">ç³»çµ±é€£ç·šä¸­...</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="ç™¼é€å»£æ’­..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        // --- åœ°åœ–è¨­å®šå€ (ä¿®æ”¹é‡é») ---
        var map = L.map('world-map', {
            minZoom: 2, // é™åˆ¶æœ€å°ç¸®æ”¾ï¼Œé¿å…ç¸®å¤ªå°çœ‹åˆ°ç°åº•
            // è¨­å®šåœ°åœ–é‚Šç•Œï¼šå·¦ä¸‹è§’ [-90, -180], å³ä¸Šè§’ [90, 180]
            maxBounds: [[-90, -180], [90, 180]], 
            maxBoundsViscosity: 1.0 // 1.0 ä»£è¡¨å®Œå…¨å¡æ­»ï¼Œä¸è®“æ‹–å‡ºå»
        }).setView([20, 0], 2);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', 
            maxZoom: 19,
            noWrap: true, // é—œéµï¼šå‘Šè¨´åœ°åœ–ç£šä¸è¦å·¦å³é‡è¤‡
            bounds: [[-90, -180], [90, 180]]
        }).addTo(map);
        // -------------------------

        var markers = {};
        var firstLoad = true;

        window.onload = function() {
            if (navigator.geolocation) {
                var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.watchPosition(
                    (pos) => { 
                        var accuracy = pos.coords.accuracy;
                        document.getElementById('gps-status').innerText = `GPS è¨Šè™Ÿé–å®š (èª¤å·® ${Math.round(accuracy)} å…¬å°º)`;
                        
                        if (firstLoad) {
                            initConnection(pos.coords.latitude, pos.coords.longitude);
                            firstLoad = false;
                        } else {
                            socket.emit('playerMove', { lat: pos.coords.latitude, lng: pos.coords.longitude });
                            if (accuracy < 100) {
                                map.setView([pos.coords