<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨çƒå³æ™‚é€šè¨Š (å»£æ’­é›»å°ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #e5e3df; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #e5e3df; }

        /* --- 1. æ–°å¢ï¼šé ‚éƒ¨å»£æ’­æ’­æ”¾å™¨æ¨£å¼ --- */
        #radio-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 2px solid #ff0055; /* éœ“è™¹ç²‰ç´…ï¼Œå€éš”èŠå¤©å®¤çš„è—è‰² */
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box;
            z-index: 3000; /* æœ€é«˜å±¤ç´š */
            color: white;
            transition: transform 0.3s;
        }
        .station-info { display: flex; flex-direction: column; max-width: 50%; }
        .station-name { font-weight: bold; font-size: 14px; color: #ff0055; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .station-country { font-size: 11px; color: #aaa; }
        
        /* HTML5 éŸ³è¨Šæ§åˆ¶é …æ¨£å¼å¾®èª¿ */
        audio { height: 30px; max-width: 150px; }

        /* --- èŠå¤©é¢æ¿ (ç¨å¾®å¾€ä¸‹ç§»ï¼Œé¿é–‹æ’­æ”¾å™¨) --- */
        #chat-panel {
            position: fixed; top: 70px; /* é¿é–‹ä¸Šé¢çš„æ’­æ”¾å™¨ */
            left: 20px;
            width: 320px; height: 55vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 10px; color: #ddd;
            display: flex; flex-direction: column;
            z-index: 2000; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        #panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid #444; }
        #panel-title { font-size: 16px; font-weight: bold; color: white; }
        #toggle-icon { font-size: 12px; color: #00ffea; border: 1px solid #00ffea; padding: 2px 6px; border-radius: 4px; }
        
        #profile-section { padding-bottom: 5px; margin-bottom: 5px; font-size: 12px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        #name-input { flex: 1; padding: 5px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; font-size: 12px;}
        #update-name-btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 12px;}

        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 5px; font-size: 13px; }
        .msg { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .msg-name { color: #00ffea; font-weight: bold; }
        .msg-text { color: white; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        
        .gps-info { font-size: 10px; color: #f39c12; margin-top: 2px; }
        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 8px; border: none; border-radius: 4px; background: #333; color: white; font-size: 14px; }
        
        /* æ¨™ç±¤èˆ‡æ°£æ³¡ */
        .user-label { background-color: #000000; color: #00ffea; border: 2px solid #00ffea; font-size: 12px; font-weight: 900; padding: 2px 6px; border-radius: 4px; white-space: nowrap; box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center; }
        
        /* 2. æ–°å¢ï¼šé›»å°å°ˆç”¨æ¨™ç±¤æ¨£å¼ (ç²‰ç´…è‰²) */
        .radio-label {
            background-color: #220011; color: #ff0055; border: 1px solid #ff0055;
            font-size: 11px; font-weight: bold; padding: 1px 4px; border-radius: 4px;
            white-space: nowrap; text-align: center;
        }

        .leaflet-popup-content-wrapper { background: white; color: black; border: 2px solid #007bff; font-weight: bold; }
        .leaflet-popup-tip { background: white; border: 2px solid #007bff; }

        /* æ‰‹æ©ŸéŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            #chat-panel {
                top: auto; left: 0; bottom: 0; width: 100%; height: 35vh;
                border-radius: 15px 15px 0 0; border-left: none; border-top: 4px solid #00ffea;
            }
            #chat-panel.minimized { height: 45px; overflow: hidden; }
            #toggle-icon { display: block; }
            
            /* æ‰‹æ©Ÿç‰ˆæ’­æ”¾å™¨ç¨å¾®ç¸®å° */
            #radio-player-bar { height: 50px; }
            .station-name { font-size: 12px; }
        }
    </style>
</head>
<body>

    <div id="radio-player-bar">
        <div class="station-info">
            <div class="station-name" id="current-station">è«‹é»æ“Šåœ°åœ–ä¸Šçš„ ğŸµ åœ–ç¤º</div>
            <div class="station-country" id="current-country">å…¨çƒå»£æ’­ç¶²å¾…å‘½ä¸­</div>
        </div>
        <audio id="audio-player" controls autoplay playsinline></audio>
    </div>

    <div id="world-map"></div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸŒ å…¨çƒè¨Šè™Ÿç«™ <span id="gps-status" class="gps-info" style="display:inline; margin-left:5px;">(å®šä½ä¸­...)</span></div>
            <div id="toggle-icon">æ”¶èµ· â–¼</div>
        </div>

        <div id="profile-section">
            <div class="input-group">
                <input type="text" id="name-input" placeholder="åå­—">
                <button id="update-name-btn">æ”¹å</button>
            </div>
        </div>

        <div id="chat-history">
            <div class="msg-sys">ç³»çµ±é€£ç·šä¸­...</div>
            <div class="msg-sys" style="color: #ff0055;">â˜… æç¤ºï¼šåœ°åœ–ä¸Šçš„ ğŸµ éŸ³ç¬¦ä»£è¡¨å»£æ’­é›»å°ï¼Œé»æ“Šå³å¯æ”¶è½ï¼</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        // é¢æ¿æ”¶åˆ
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            var icon = document.getElementById('toggle-icon');
            if (isMinimized) {
                panel.classList.remove('minimized');
                icon.innerText = "æ”¶èµ· â–¼";
                isMinimized = false;
            } else {
                panel.classList.add('minimized');
                icon.innerText = "å±•é–‹ â–²";
                isMinimized = true;
            }
        }

        // åˆå§‹åŒ–åœ°åœ– (é™åˆ¶é‚Šç•Œ)
        var map = L.map('world-map', {
            minZoom: 2,
            maxBounds: [[-90, -180], [90, 180]], 
            maxBoundsViscosity: 1.0,
            zoomControl: false 
        }).setView([20, 0], 3);

        if (window.innerWidth > 768) L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Maps',
            maxZoom: 20, noWrap: true, bounds: [[-90, -180], [90, 180]]
        }).addTo(map);

        // --- è®Šæ•¸å€ ---
        var markers = {};
        var accuracyCircle = null;
        var firstLoad = true;
        var radioLayer = L.layerGroup().addTo(map); // å°ˆé–€æ”¾é›»å°çš„åœ–å±¤

        // --- å»£æ’­é›»å°åŠŸèƒ½æ ¸å¿ƒ ---
        
        // é›»å°åœ–ç¤º (éŸ³ç¬¦)
        var radioIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ff0055;width:30px;height:30px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:2px solid white;box-shadow:0 0 5px black;font-size:16px;'>ğŸµ</div>",
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        // è¼‰å…¥å…¨çƒç†±é–€é›»å° (ä½¿ç”¨ Radio Browser API)
        function loadRadioStations() {
            // æˆ‘å€‘æŠ“å–å…¨çƒé»æ“Šç‡æœ€é«˜çš„ 100 å€‹ä¸”æœ‰ç¶“ç·¯åº¦è³‡è¨Šçš„é›»å°
            var apiUrl = "https://de1.api.radio-browser.info/json/stations/topclick?limit=100&hidebroken=true&has_geo_info=true";
            
            fetch(apiUrl)
            .then(response => response.json())
            .then(stations => {
                stations.forEach(station => {
                    if (station.geo_lat && station.geo_long) {
                        // å»ºç«‹æ¨™è¨˜
                        var marker = L.marker([station.geo_lat, station.geo_long], {icon: radioIcon})
                            .bindTooltip(station.name, { 
                                direction: 'top', className: 'radio-label', offset: [0, -15]
                            });
                        
                        // é»æ“Šäº‹ä»¶ï¼šæ’­æ”¾éŸ³æ¨‚
                        marker.on('click', function() {
                            playRadio(station.name, station.country, station.url_resolved);
                            
                            // è¦–è¦ºå›é¥‹ï¼šåœ°åœ–é£›éå»
                            map.setView([station.geo_lat, station.geo_long], 10);
                            
                            // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè³‡è¨Š
                            marker.bindPopup(`<b>æ­£åœ¨æ’­æ”¾:</b><br>${station.name}<br>(${station.country})`).openPopup();
                        });

                        radioLayer.addLayer(marker);
                    }
                });
                addSystemMsg(`å·²è¼‰å…¥ ${stations.length} å€‹å…¨çƒç†±é–€é›»å° ğŸµ`);
            })
            .catch(err => console.error("é›»å°è¼‰å…¥å¤±æ•—", err));
        }

        // æ’­æ”¾æ§åˆ¶
        function playRadio(name, country, url) {
            var player = document.getElementById('audio-player');
            var nameDisplay = document.getElementById('current-station');
            var countryDisplay = document.getElementById('current-country');

            // è§£æ±ºæ··åˆå…§å®¹å•é¡Œ (å¦‚æœæ˜¯ http å¼·åˆ¶è½‰ https è©¦è©¦çœ‹ï¼Œä¸ä¸€å®šæˆåŠŸä½†å€¼å¾—ä¸€è©¦)
            // å¾ˆå¤šé›»å°ä¸²æµé‚„æ˜¯ httpï¼Œé€™åœ¨ https ç¶²ç«™ä¸Šå¯èƒ½æœƒè¢«ç€è¦½å™¨æ“‹æ‰
            // å¦‚æœä½ æ˜¯ç”¨ localhost æ¸¬è©¦é€šå¸¸æ²’å•é¡Œ
            
            player.src = url;
            player.play().catch(e => {
                alert("ç„¡æ³•æ’­æ”¾æ­¤é›»å° (å¯èƒ½é€£ç·šä¸ç©©æˆ–ä¾†æºé™åˆ¶)");
                console.error(e);
            });

            nameDisplay.innerText = "ğŸµ " + name;
            countryDisplay.innerText = country;
        }

        // å•Ÿå‹•æ™‚è¼‰å…¥é›»å°
        loadRadioStations();
        // -------------------------


        window.onload = function() {
            if (navigator.geolocation) {
                var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.watchPosition(
                    (pos) => { 
                        var lat = pos.coords.latitude;
                        var lng = pos.coords.longitude;
                        var accuracy = pos.coords.accuracy;

                        document.getElementById('gps-status').innerText = `(èª¤å·®${Math.round(accuracy)}m)`;
                        
                        if (accuracyCircle) {
                            accuracyCircle.setLatLng([lat, lng]);
                            accuracyCircle.setRadius(accuracy);
                        } else {
                            accuracyCircle = L.circle([lat, lng], {
                                color: '#007bff', fillColor: '#007bff', fillOpacity: 0.1, radius: accuracy
                            }).addTo(map);
                        }

                        if (firstLoad) {
                            initConnection(lat, lng);
                            map.fitBounds(accuracyCircle.getBounds());
                            firstLoad = false;
                        } else {
                            socket.emit('playerMove', { lat: lat, lng: lng });
                        }
                    },
                    (err) => { 
                        document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)";
                        if(firstLoad) {
                            initConnection(20 + Math.random()*10, 120 + Math.random()*10);
                            firstLoad = false;
                        }
                    },
                    options
                );
            } else {
                initConnection(25.03, 121.56);
            }
        };

        function initConnection(lat, lng) {
            socket.emit('reportLocation', { lat: lat, lng: lng });
            addSystemMsg("é€£ç·šæˆåŠŸ");
        }

        socket.on('yourNameIs', function(name) {
            document.getElementById('name-input').value = name;
        });

        socket.on('history', function(historyMessages) {
            historyMessages.forEach(function(data) {
                if (data.isSystem) addSystemMsg(data.text);
                else addUserMsg(data.name, data.text);
            });
            var box = document.getElementById('chat-history');
            box.scrollTop = box.scrollHeight;
        });

        function updateName() {
            var newName = document.getElementById('name-input').value;
            if (newName.trim() !== "") {
                socket.emit('changeName', newName);
            }
        }
        document.getElementById('update-name-btn').addEventListener('click', updateName);

        map.on('click', function(e) {
            socket.emit('playerMove', { lat: e.latlng.lat, lng: e.latlng.lng });
            map.panTo(e.latlng);
            if(accuracyCircle) {
                accuracyCircle.setLatLng(e.latlng);
                accuracyCircle.setRadius(5); 
            }
        });

        socket.on('updateMap', function(allUsers) {
            for(var id in markers) { map.removeLayer(markers[id]); }
            markers = {};
            for (var id in allUsers) {
                var u = allUsers[id];
                var marker = L.marker([u.lat, u.lng]).addTo(map);
                marker.bindTooltip(u.name, { 
                    permanent: true, direction: 'top', className: 'user-label', offset: [0, -40]
                });
                markers[id] = marker;
            }
        });

        socket.on('chatMessage', function(data) {
            if (data.isSystem) {
                addSystemMsg(data.text);
            } else {
                addUserMsg(data.name, data.text);
                if (markers[data.id]) {
                    markers[data.id].bindPopup(data.text).openPopup();
                    setTimeout(() => { if(markers[data.id]) markers[data.id].closePopup(); }, 3000);
                }
            }
        });

        function addSystemMsg(text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `<div class="msg msg-sys">${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function addUserMsg(name, text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `
                <div class="msg">
                    <span class="msg-name">${name}:</span> 
                    <span class="msg-text">${text}</span>
                </div>`;
            box.scrollTop = box.scrollHeight;
        }

        var input = document.getElementById('msg-input');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                socket.emit('sendChat', input.value);
                input.value = "";
            }
        });
        
        input.addEventListener('focus', function() {
            if (window.innerWidth <= 768) document.getElementById('chat-panel').style.height = '50vh';
        });
        input.addEventListener('blur', function() {
            if (window.innerWidth <= 768 && !isMinimized) document.getElementById('chat-panel').style.height = '35vh';
        });
    </script>
</body>
</html>