<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨çƒå³æ™‚é€šè¨Š (æ™ºæ…§é›»å°ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #e5e3df; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #e5e3df; }

        /* é ‚éƒ¨å»£æ’­æ’­æ”¾å™¨ */
        #radio-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 2px solid #ff0055;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box;
            z-index: 3000; color: white;
            transition: transform 0.3s;
        }
        .station-info { display: flex; flex-direction: column; max-width: 50%; }
        .station-name { font-weight: bold; font-size: 14px; color: #ff0055; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .station-country { font-size: 11px; color: #aaa; }
        audio { height: 30px; max-width: 150px; }

        /* è®€å–ä¸­æç¤º (æ–°å¢) */
        #loading-badge {
            position: fixed; top: 70px; right: 10px;
            background: rgba(0,0,0,0.8); color: #00ffea;
            padding: 5px 10px; border-radius: 20px; font-size: 12px;
            z-index: 3000; display: none; border: 1px solid #00ffea;
        }

        /* èŠå¤©é¢æ¿ */
        #chat-panel {
            position: fixed; top: 70px; left: 20px;
            width: 320px; height: 55vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 10px; color: #ddd;
            display: flex; flex-direction: column;
            z-index: 2000; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        #panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid #444; }
        #panel-title { font-size: 16px; font-weight: bold; color: white; }
        #toggle-icon { font-size: 12px; color: #00ffea; border: 1px solid #00ffea; padding: 2px 6px; border-radius: 4px; }
        #profile-section { padding-bottom: 5px; margin-bottom: 5px; font-size: 12px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        #name-input { flex: 1; padding: 5px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; font-size: 12px;}
        #update-name-btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 12px;}
        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 5px; font-size: 13px; }
        .msg { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .msg-name { color: #00ffea; font-weight: bold; }
        .msg-text { color: white; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        .gps-info { font-size: 10px; color: #f39c12; margin-top: 2px; }
        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 8px; border: none; border-radius: 4px; background: #333; color: white; font-size: 14px; }
        
        .user-label { background-color: #000000; color: #00ffea; border: 2px solid #00ffea; font-size: 12px; font-weight: 900; padding: 2px 6px; border-radius: 4px; white-space: nowrap; box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center; }
        .radio-label { background-color: #220011; color: #ff0055; border: 1px solid #ff0055; font-size: 11px; font-weight: bold; padding: 1px 4px; border-radius: 4px; white-space: nowrap; text-align: center; }
        .leaflet-popup-content-wrapper { background: white; color: black; border: 2px solid #007bff; font-weight: bold; }
        
        /* èšåˆåœ–ç¤ºæ¨£å¼ */
        .marker-cluster-small { background-color: rgba(255, 0, 85, 0.6); }
        .marker-cluster-small div { background-color: rgba(255, 0, 85, 0.8); color: white; font-weight: bold; }
        .marker-cluster-medium { background-color: rgba(255, 0, 85, 0.6); }
        .marker-cluster-medium div { background-color: rgba(255, 0, 85, 0.9); color: white; font-weight: bold; }
        .marker-cluster-large { background-color: rgba(255, 0, 85, 0.6); }
        .marker-cluster-large div { background-color: rgba(255, 0, 85, 1.0); color: white; font-weight: bold; }

        @media (max-width: 768px) {
            #chat-panel { top: auto; left: 0; bottom: 0; width: 100%; height: 35vh; border-radius: 15px 15px 0 0; border-left: none; border-top: 4px solid #00ffea; }
            #chat-panel.minimized { height: 45px; overflow: hidden; }
            #toggle-icon { display: block; }
            #radio-player-bar { height: 50px; }
            .station-name { font-size: 12px; }
        }
    </style>
</head>
<body>

    <div id="radio-player-bar">
        <div class="station-info">
            <div class="station-name" id="current-station">ğŸµ ç§»å‹•åœ°åœ–ä»¥æœå°‹é›»å°</div>
            <div class="station-country" id="current-country">æ™ºæ…§æœå°‹æ¨¡å¼</div>
        </div>
        <audio id="audio-player" controls autoplay playsinline></audio>
    </div>

    <div id="loading-badge">ğŸ“¡ æ­£åœ¨æœå°‹æ­¤å€åŸŸé›»å°...</div>

    <div id="world-map"></div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸŒ å…¨çƒè¨Šè™Ÿç«™ <span id="gps-status" class="gps-info" style="display:inline; margin-left:5px;">(å®šä½ä¸­...)</span></div>
            <div id="toggle-icon">æ”¶èµ· â–¼</div>
        </div>
        <div id="profile-section">
            <div class="input-group">
                <input type="text" id="name-input" placeholder="åå­—">
                <button id="update-name-btn">æ”¹å</button>
            </div>
        </div>
        <div id="chat-history">
            <div class="msg-sys">ç³»çµ±é€£ç·šä¸­...</div>
            <div class="msg-sys" style="color: #ff0055;">â˜… æ™ºæ…§å»£æ’­ï¼šç§»å‹•åœ°åœ–ï¼Œæœƒè‡ªå‹•è¼‰å…¥ç•¶åœ°çš„é›»å°ã€‚</div>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            var icon = document.getElementById('toggle-icon');
            if (isMinimized) { panel.classList.remove('minimized'); icon.innerText = "æ”¶èµ· â–¼"; isMinimized = false; } 
            else { panel.classList.add('minimized'); icon.innerText = "å±•é–‹ â–²"; isMinimized = true; }
        }

        var map = L.map('world-map', {
            minZoom: 2, maxBounds: [[-90, -180], [90, 180]], maxBoundsViscosity: 1.0, zoomControl: false 
        }).setView([25, 121], 3);

        if (window.innerWidth > 768) L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Maps', maxZoom: 20, noWrap: true, bounds: [[-90, -180], [90, 180]]
        }).addTo(map);

        var markers = {};
        var accuracyCircle = null;
        var firstLoad = true;
        var loadedStationIds = new Set(); // ç”¨ä¾†è¨˜éŒ„å·²ç¶“è¼‰å…¥éçš„é›»å° IDï¼Œé¿å…é‡è¤‡
        var searchTimeout = null;

        var radioCluster = L.markerClusterGroup({
            maxClusterRadius: 50, disableClusteringAtZoom: 13
        });
        map.addLayer(radioCluster);

        var radioIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ff0055;width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:2px solid white;box-shadow:0 0 5px black;font-size:12px;'>ğŸµ</div>",
            iconSize: [24, 24], iconAnchor: [12, 12]
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ™ºæ…§è¼‰å…¥é›»å° ---
        
        // 1. åŸºç¤è¼‰å…¥ï¼šå…ˆæŠ“å…¨çƒæœ€ç†±é–€çš„ 500 å€‹æ’å ´é¢
        function loadTopStations() {
            fetch("https://de1.api.radio-browser.info/json/stations/search?limit=500&hidebroken=true&has_geo_info=true&is_https=true&order=clickcount&reverse=true")
            .then(res => res.json())
            .then(data => addStationsToMap(data));
        }

        // 2. é€²éšè¼‰å…¥ï¼šæ ¹æ“šåœ°åœ–ç›®å‰çš„ã€Œé‚Šç•Œ (Bounds)ã€å»æœå°‹
        function loadStationsInView() {
            var bounds = map.getBounds();
            var north = bounds.getNorth();
            var south = bounds.getSouth();
            var east = bounds.getEast();
            var west = bounds.getWest();

            // é¡¯ç¤ºè®€å–ä¸­
            document.getElementById('loading-badge').style.display = 'block';

            // API åƒæ•¸ï¼šåªæŠ“å–é€™å¡Šé•·æ–¹å½¢å€åŸŸå…§çš„ HTTPS é›»å°
            // é™åˆ¶ 200 å€‹ä»¥å…ç•¶åœ°å¤ªå¯†é›†å¡æ­»
            var apiUrl = `https://de1.api.radio-browser.info/json/stations/search?limit=200&hidebroken=true&is_https=true&lat_min=${south}&lat_max=${north}&long_min=${west}&long_max=${east}`;

            fetch(apiUrl)
            .then(res => res.json())
            .then(stations => {
                addStationsToMap(stations);
                document.getElementById('loading-badge').style.display = 'none';
                
                if (stations.length > 0) {
                    document.getElementById('current-country').innerText = `å·²åœ¨æ­¤å€åŸŸç™¼ç¾ ${stations.length} å€‹é›»å°`;
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loading-badge').style.display = 'none';
            });
        }

        function addStationsToMap(stations) {
            stations.forEach(station => {
                // å¦‚æœé€™å€‹é›»å°å·²ç¶“åŠ éï¼Œå°±è·³é
                if (!loadedStationIds.has(station.stationuuid)) {
                    if (station.geo_lat && station.geo_long) {
                        var marker = L.marker([station.geo_lat, station.geo_long], {icon: radioIcon})
                            .bindTooltip(station.name, { direction: 'top', className: 'radio-label', offset: [0, -12] });
                        
                        marker.on('click', function() {
                            playRadio(station.name, station.country, station.url_resolved);
                        });
                        radioCluster.addLayer(marker);
                        loadedStationIds.add(station.stationuuid);
                    }
                }
            });
        }

        // 3. ç›£è½åœ°åœ–ç§»å‹•äº‹ä»¶ï¼šç•¶ä½¿ç”¨è€…æ‹–æ›³ä¸¦ã€Œåœä¸‹ä¾†ã€å¾Œæ‰æœå°‹
        map.on('moveend', function() {
            // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨ (é˜²æŠ–å‹• Debounce)
            if (searchTimeout) clearTimeout(searchTimeout);
            // åœä¸‹ä¾† 1 ç§’å¾Œæ‰é–‹å§‹æœå°‹ï¼Œé¿å…ç§»å‹•ä¸­ç˜‹ç‹‚ç™¼è«‹æ±‚
            searchTimeout = setTimeout(loadStationsInView, 1000);
        });

        // ä¸€é–‹å§‹å…ˆè¼‰å…¥ç†±é–€çš„
        loadTopStations();
        // -------------------------

        function playRadio(name, country, url) {
            var player = document.getElementById('audio-player');
            var nameDisplay = document.getElementById('current-station');
            var countryDisplay = document.getElementById('current-country');
            player.src = url;
            nameDisplay.innerText = "è®€å–ä¸­...";
            player.play().then(() => {
                nameDisplay.innerText = "ğŸµ " + name;
                countryDisplay.innerText = country;
            }).catch(e => {
                nameDisplay.innerText = "âŒ æ’­æ”¾å¤±æ•—";
                countryDisplay.innerText = "æ­¤ä¾†æºå¯èƒ½ä¸æ”¯æ´ HTTPS";
            });
        }

        // --- GPS èˆ‡èŠå¤© ---
        window.onload = function() {
            if (navigator.geolocation) {
                var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.watchPosition(
                    (pos) => { 
                        var lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
                        document.getElementById('gps-status').innerText = `(èª¤å·®${Math.round(acc)}m)`;
                        if (accuracyCircle) { accuracyCircle.setLatLng([lat, lng]); accuracyCircle.setRadius(acc); } 
                        else { accuracyCircle = L.circle([lat, lng], { color: '#007bff', fillColor: '#007bff', fillOpacity: 0.1, radius: acc }).addTo(map); }
                        if (firstLoad) { 
                            initConnection(lat, lng); 
                            map.fitBounds(accuracyCircle.getBounds()); 
                            firstLoad = false; 
                            // ç¬¬ä¸€æ¬¡å®šä½åˆ°å¾Œï¼Œé¦¬ä¸Šæœå°‹è©²å€åŸŸé›»å°
                            setTimeout(loadStationsInView, 1500); 
                        } else { socket.emit('playerMove', { lat: lat, lng: lng }); }
                    },
                    (err) => { document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)"; if(firstLoad){ initConnection(20+Math.random()*10, 120+Math.random()*10); firstLoad=false; } },
                    options
                );
            } else { initConnection(25.03, 121.56); }
        };

        function initConnection(lat, lng) { socket.emit('reportLocation', { lat: lat, lng: lng }); addSystemMsg("é€£ç·šæˆåŠŸ"); }
        socket.on('yourNameIs', function(name) { document.getElementById('name-input').value = name; });
        socket.on('history', function(h) { h.forEach(d => d.isSystem ? addSystemMsg(d.text) : addUserMsg(d.name, d.text)); var b=document.getElementById('chat-history'); b.scrollTop=b.scrollHeight; });
        function updateName() { var n=document.getElementById('name-input').value; if(n.trim()) socket.emit('changeName', n); }
        document.getElementById('update-name-btn').addEventListener('click', updateName);
        map.on('click', function(e) { socket.emit('playerMove', { lat: e.latlng.lat, lng: e.latlng.lng }); map.panTo(e.latlng); if(accuracyCircle){ accuracyCircle.setLatLng(e.latlng); accuracyCircle.setRadius(5); } });
        socket.on('updateMap', function(u) { for(var i in markers) map.removeLayer(markers[i]); markers={}; for(var i in u) { var m=L.marker([u[i].lat, u[i].lng]).addTo(map); m.bindTooltip(u[i].name, { permanent:true, direction:'top', className:'user-label', offset:[0,-40] }); markers[i]=m; } });
        socket.on('chatMessage', function(d) { if(d.isSystem) addSystemMsg(d.text); else { addUserMsg(d.name, d.text); if(markers[d.id]) { markers[d.id].bindPopup(d.text).openPopup(); setTimeout(()=>markers[d.id]&&markers[d.id].closePopup(),3000); } } });
        function addSystemMsg(t) { var b=document.getElementById('chat-history'); b.innerHTML+=`<div class="msg msg-sys">${t}</div>`; b.scrollTop=b.scrollHeight; }
        function addUserMsg(n, t) { var b=document.getElementById('chat-history'); b.innerHTML+=`<div class="msg"><span class="msg-name">${n}:</span> <span class="msg-text">${t}</span></div>`; b.scrollTop=b.scrollHeight; }
        var input=document.getElementById('msg-input'); input.addEventListener('keypress', function(e){ if(e.key==='Enter'&&input.value.trim()){ socket.emit('sendChat', input.value); input.value=""; } });
        input.addEventListener('focus', function(){ if(window.innerWidth<=768) document.getElementById('chat-panel').style.height='50vh'; });
        input.addEventListener('blur', function(){ if(window.innerWidth<=768&&!isMinimized) document.getElementById('chat-panel').style.height='35vh'; });
    </script>
</body>
</html>