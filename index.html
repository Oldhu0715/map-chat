<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D å…¨çƒå»£æ’­ (Cesiumç‰ˆ)</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; overflow: hidden; background: black; }
        #cesiumContainer { width: 100%; height: 100vh; margin: 0; padding: 0; overflow: hidden; }

        /* ä»‹é¢æ¨£å¼ - æ¨¡ä»¿ Radio Garden çš„æ¥µç°¡é»‘é€é¢¨æ ¼ */
        
        /* 1. é ‚éƒ¨æ’­æ”¾å™¨ */
        #radio-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            background: rgba(0, 0, 0, 0.6); /* æ¥µç°¡åŠé€æ˜ */
            backdrop-filter: blur(10px);    /* æ¯›ç»ç’ƒç‰¹æ•ˆ */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; box-sizing: border-box;
            z-index: 100; color: white;
        }
        .station-info { display: flex; flex-direction: column; }
        .station-name { font-size: 18px; font-weight: bold; color: #00ffaa; /* ç¶“å…¸ç¶ è‰² */ text-shadow: 0 0 10px #00ffaa; }
        .station-country { font-size: 12px; color: #ccc; letter-spacing: 1px; }
        
        /* 2. èŠå¤©é¢æ¿ (æ‡¸æµ®åœ¨åœ°çƒä¹‹ä¸Š) */
        #chat-panel {
            position: fixed; top: 90px; left: 20px;
            width: 300px; height: 50vh;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 170, 0.3);
            border-radius: 10px;
            padding: 10px; color: #ddd;
            display: flex; flex-direction: column;
            z-index: 100;
            backdrop-filter: blur(5px);
            transition: all 0.3s;
        }
        #chat-panel.minimized { height: 40px; overflow: hidden; background: rgba(0,0,0,0.8); }
        
        #panel-header { display: flex; justify-content: space-between; cursor: pointer; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;}
        #panel-title { color: #fff; font-weight: bold; }
        #chat-history { flex: 1; overflow-y: auto; font-size: 13px; scrollbar-width: thin; }
        .msg { margin-bottom: 5px; }
        .msg-name { color: #00ffaa; font-weight: bold; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        
        #input-area { display: flex; gap: 5px; margin-top: 5px; }
        #msg-input { flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px; border-radius: 4px; }
        
        /* 3. ä¸­å¿ƒæº–å¿ƒ (ç„æº–å™¨) */
        #crosshair {
            position: fixed; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 90;
            pointer-events: none; /* è®“æ»‘é¼ å¯ä»¥ç©¿é€å®ƒé»åœ°åœ– */
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        /* 4. è®€å–æç¤º */
        #loading-badge {
            position: fixed; bottom: 20px; right: 20px;
            color: #00ffaa; font-size: 12px; z-index: 100;
            text-shadow: 0 0 5px black;
        }

        /* éš±è— Cesium çš„ç‰ˆæ¬Šæ–‡å­— (åƒ…ä¾›å€‹äººç·´ç¿’ç”¨) */
        .cesium-viewer-bottom { display: none; }

        @media (max-width: 768px) {
            #chat-panel { top: auto; bottom: 0; left: 0; width: 100%; height: 35vh; border-radius: 15px 15px 0 0; }
            #radio-player-bar { height: 60px; }
            audio { max-width: 100px; }
        }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div id="crosshair"></div>

    <div id="radio-player-bar">
        <div class="station-info">
            <div class="station-name" id="current-station">Radio Garden 3D</div>
            <div class="station-country" id="current-country">æ—‹è½‰åœ°çƒä»¥æ¢ç´¢</div>
        </div>
        <audio id="audio-player" controls autoplay playsinline></audio>
    </div>

    <div id="loading-badge">æ­£åœ¨åˆå§‹åŒ– 3D å¼•æ“...</div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸ“¡ å…¨çƒè¨Šè™Ÿ <span id="gps-status" style="font-size:10px;color:#aaa;">(å®šä½ä¸­)</span></div>
            <div style="color:#00ffaa;">â–¼</div>
        </div>
        <div id="chat-history">
            <div class="msg-sys">æ­¡è¿ä¾†åˆ° 3D å»£æ’­ä¸–ç•Œã€‚</div>
            <div class="msg-sys">ç¶ è‰²å…‰é»ä»£è¡¨é›»å°ï¼Œé»æ“Šå³å¯æ”¶è½ã€‚</div>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            if (isMinimized) { panel.classList.remove('minimized'); isMinimized = false; } 
            else { panel.classList.add('minimized'); isMinimized = true; }
        }

        // --- 1. åˆå§‹åŒ– Cesium 3D åœ°çƒ ---
        // ä½¿ç”¨ OpenStreetMap ä½œç‚ºè²¼åœ– (å…è²»ï¼Œç„¡éœ€ Token)
        var viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                url : 'https://a.tile.openstreetmap.org/'
            }),
            baseLayerPicker: false, // é—œé–‰åœ–å±¤é¸æ“‡å™¨
            geocoder: false,       // é—œé–‰æœå°‹
            homeButton: false,     // é—œé–‰é¦–é éˆ•
            infoBox: false,        // é—œé–‰é è¨­è³‡è¨Šæ¡†
            sceneModePicker: false,// é—œé–‰ 2D/3D åˆ‡æ›
            selectionIndicator: false,
            timeline: false,       // é—œé–‰æ™‚é–“è»¸
            navigationHelpButton: false,
            animation: false,      // é—œé–‰å‹•ç•«æ§åˆ¶
            scene3DOnly: true,
            contextOptions: {
                webgl: { alpha: true }
            }
        });

        // é–‹å•Ÿè¿·éœ§æ•ˆæœ (è®“å¤§æ°£å±¤çœ‹èµ·ä¾†æ›´çœŸå¯¦)
        viewer.scene.fog.enabled = true;
        viewer.scene.fog.density = 0.0002;
        viewer.scene.globe.enableLighting = true; // é–‹å•Ÿæ—¥ç…§é™°å½±

        // --- 2. å»£æ’­é›»å°åŠŸèƒ½ (ç¶ è‰²å…‰é») ---
        var stationsDataSource = new Cesium.CustomDataSource('stations');
        viewer.dataSources.add(stationsDataSource);

        function loadRadioStations() {
            document.getElementById('loading-badge').innerText = "æ­£åœ¨ä¸‹è¼‰å…¨çƒé›»å°è³‡æ–™...";
            
            // æŠ“å–å…¨çƒç†±é–€ 2000 å° (Radio Garden ç­‰ç´šçš„æ•¸é‡)
            // ä¸é™ HTTPSï¼Œå› ç‚ºæˆ‘å€‘æœ‰ä¼ºæœå™¨ä¸­è½‰
            var apiUrl = "https://de1.api.radio-browser.info/json/stations/search?limit=2000&hidebroken=true&has_geo_info=true&order=clickcount&reverse=true";

            fetch(apiUrl)
            .then(res => res.json())
            .then(stations => {
                stations.forEach(station => {
                    if (station.geo_lat && station.geo_long) {
                        stationsDataSource.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(station.geo_long, station.geo_lat),
                            point: {
                                pixelSize: 6, // é»çš„å¤§å°
                                color: Cesium.Color.fromCssColorString('#00ffaa'), // ç¶“å…¸è¢å…‰ç¶ 
                                outlineColor: Cesium.Color.BLACK,
                                outlineWidth: 1,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND, // è²¼åœ¨åœ°é¢
                                distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, 5000000.0), // å¤ªé æ™‚éš±è—ï¼Œå„ªåŒ–æ•ˆèƒ½
                                translucencyByDistance: new Cesium.NearFarScalar(1.5e2, 1.0, 1.5e7, 0.2) // é è™•è®ŠåŠé€æ˜
                            },
                            // å„²å­˜é›»å°è³‡æ–™ä¾›é»æ“Šä½¿ç”¨
                            properties: {
                                name: station.name,
                                country: station.country,
                                url: station.url_resolved
                            }
                        });
                    }
                });
                document.getElementById('loading-badge').innerText = `å·²è¼‰å…¥ ${stations.length} å€‹è¨Šè™Ÿæº`;
                setTimeout(() => { document.getElementById('loading-badge').style.display='none'; }, 3000);
            });
        }
        loadRadioStations();

        // --- 3. é»æ“Šé›»å°æ’­æ”¾ ---
        var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(click) {
            var pickedObject = viewer.scene.pick(click.position);
            
            if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties) {
                var props = pickedObject.id.properties;
                playRadio(props.name.getValue(), props.country.getValue(), props.url.getValue());
                
                // é¡é ­é£›å‘è©²é›»å° (åƒ Radio Garden ä¸€æ¨£)
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(
                        pickedObject.id.position.getValue(Cesium.JulianDate.now()).x, // é€™è£¡éœ€è¦è½‰æ›ï¼Œç°¡åŒ–è™•ç†ç›´æ¥ç”¨åŸåº§æ¨™
                        // å¯¦éš›ä¸Š Cartesian3 è½‰æ›æ¯”è¼ƒè¤‡é›œï¼Œæˆ‘å€‘ç°¡å–®è®“é¡é ­å¾€ä¸‹çœ‹
                        0, 0 
                    )
                });
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        function playRadio(name, country, url) {
            var player = document.getElementById('audio-player');
            var finalUrl = url;
            if (url.startsWith('http://')) {
                finalUrl = '/radio-proxy?url=' + encodeURIComponent(url);
            }
            player.src = finalUrl;
            document.getElementById('current-station').innerText = "é€£ç·šä¸­... " + name;
            player.play().then(() => {
                document.getElementById('current-station').innerText = name;
                document.getElementById('current-country').innerText = country;
            }).catch(() => {
                document.getElementById('current-station').innerText = "âŒ è¨Šè™Ÿä¸­æ–·";
            });
        }

        // --- 4. ç©å®¶ GPS èˆ‡å¤šäººé€£ç·š ---
        var playerEntities = {}; // å­˜å…¶ä»–ç©å®¶
        var myEntity = null;

        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    document.getElementById('gps-status').innerText = "(è¨Šè™Ÿè‰¯å¥½)";

                    // ç¬¬ä¸€æ¬¡å®šä½ï¼Œé£›éå»
                    if (!myEntity) {
                        viewer.camera.flyTo({
                            destination : Cesium.Cartesian3.fromDegrees(lng, lat, 2000000) // é«˜åº¦ 2000å…¬é‡Œ
                        });
                        initConnection(lat, lng);
                    } else {
                        socket.emit('playerMove', { lat: lat, lng: lng });
                    }
                }, (err) => {
                    document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)";
                    initConnection(25.03, 121.56);
                }, { enableHighAccuracy: true });
            } else {
                initConnection(25.03, 121.56);
            }
        };

        function initConnection(lat, lng) {
            socket.emit('reportLocation', { lat: lat, lng: lng });
            myEntity = true; // æ¨™è¨˜å·²é€£ç·š
        }

        // é¡¯ç¤ºå…¶ä»–ç©å®¶ (ç”¨è—è‰²é»é»)
        socket.on('updateMap', function(users) {
            // ç°¡å–®è™•ç†ï¼šæ¸…ç©ºé‡ç•« (æ•ˆèƒ½å„ªåŒ–å¯æ”¹ç‚ºæ›´æ–°ä½ç½®)
            // é€™è£¡ç‚ºäº†ä¸é–ƒçˆï¼Œæˆ‘å€‘åªæ›´æ–°ä½ç½®ï¼Œä¸åˆªé™¤é‡å»º
            
            // 1. æ¨™è¨˜æ‰€æœ‰ç¾å­˜ ID
            var activeIds = new Set();
            for (var id in users) {
                activeIds.add(id);
                var u = users[id];
                
                if (playerEntities[id]) {
                    // æ›´æ–°ä½ç½®
                    playerEntities[id].position = Cesium.Cartesian3.fromDegrees(u.lng, u.lat);
                } else {
                    // å»ºç«‹æ–°ç©å®¶
                    var entity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(u.lng, u.lat),
                        point: {
                            pixelSize: 10,
                            color: Cesium.Color.CYAN,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        label: {
                            text: u.name,
                            font: '12px sans-serif',
                            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                            fillColor: Cesium.Color.CYAN,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset: new Cesium.Cartesian2(0, -10),
                            distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, 1000000.0) // å¤ªé ä¸é¡¯ç¤ºåå­—
                        }
                    });
                    playerEntities[id] = entity;
                }
            }

            // 2. ç§»é™¤æ–·ç·šç©å®¶
            for (var existingId in playerEntities) {
                if (!activeIds.has(existingId)) {
                    viewer.entities.remove(playerEntities[existingId]);
                    delete playerEntities[existingId];
                }
            }
        });

        // èŠå¤©åŠŸèƒ½
        socket.on('history', function(h) { 
            var b = document.getElementById('chat-history');
            h.forEach(d => {
                b.innerHTML += `<div class="msg"><span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}${d.text}</span></div>`;
            });
            b.scrollTop = b.scrollHeight;
        });

        socket.on('chatMessage', function(d) {
            var b = document.getElementById('chat-history');
            b.innerHTML += `<div class="msg"><span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}${d.text}</span></div>`;
            b.scrollTop = b.scrollHeight;
            
            // 3D æ°£æ³¡å¤ªè¤‡é›œï¼Œé€™è£¡å…ˆçœç•¥ï¼Œåªç”¨å·¦å´èŠå¤©æ¬„
        });

        var input = document.getElementById('msg-input');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && input.value.trim()) {
                socket.emit('sendChat', input.value);
                input.value = "";
            }
        });

    </script>
</body>
</html>