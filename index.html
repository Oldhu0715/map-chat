<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨çƒå³æ™‚é€šè¨Š (æ‰‹æ©Ÿå„ªåŒ–ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #e5e3df; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #e5e3df; }

        /* --- é›»è…¦ç‰ˆæ¨£å¼ (é è¨­) --- */
        #chat-panel {
            position: fixed; top: 20px; left: 20px;
            width: 320px; height: 60vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 10px; /* ç¨å¾®ç¸®å°å…§è· */
            color: #ddd;
            display: flex; flex-direction: column;
            z-index: 2000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease; /* åŠ å…¥å‹•ç•«æ•ˆæœ */
        }

        /* æ¨™é¡Œåˆ—å€åŸŸ (åŠ å…¥é»æ“Šæ”¶åˆåŠŸèƒ½) */
        #panel-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; cursor: pointer; /* è®“æ»‘é¼ è®Šæ‰‹æ‰‹ */
            padding-bottom: 5px; border-bottom: 1px solid #444;
        }
        #panel-title { font-size: 16px; font-weight: bold; color: white; }
        #toggle-icon { font-size: 12px; color: #00ffea; border: 1px solid #00ffea; padding: 2px 6px; border-radius: 4px; }

        #profile-section { padding-bottom: 5px; margin-bottom: 5px; font-size: 12px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        #name-input { flex: 1; padding: 5px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; font-size: 12px;}
        #update-name-btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 12px;}

        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 5px; font-size: 13px; }
        .msg { margin-bottom: 4px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .msg-name { color: #00ffea; font-weight: bold; }
        .msg-text { color: white; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        
        .gps-info { font-size: 10px; color: #f39c12; margin-top: 2px; }
        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 8px; border: none; border-radius: 4px; background: #333; color: white; font-size: 14px; }
        
        /* åå­—æ¨™ç±¤ */
        .user-label {
            background-color: #000000; color: #00ffea; border: 2px solid #00ffea;
            font-size: 12px; font-weight: 900; padding: 2px 6px; border-radius: 4px;
            white-space: nowrap; box-shadow: 0 0 5px rgba(0,0,0,0.5); text-align: center;
        }
        .leaflet-popup-content-wrapper { background: white; color: black; border: 2px solid #007bff; font-weight: bold; }
        .leaflet-popup-tip { background: white; border: 2px solid #007bff; }


        /* --- é—œéµä¿®æ”¹ï¼šæ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼æ¨£å¼ (è¢å¹•å°æ–¼ 768px æ™‚è§¸ç™¼) --- */
        @media (max-width: 768px) {
            #chat-panel {
                top: auto;       /* å–æ¶ˆé ‚éƒ¨å›ºå®š */
                left: 0;         /* å–æ¶ˆå·¦å´å›ºå®š */
                bottom: 0;       /* å›ºå®šåœ¨åº•éƒ¨ */
                width: 100%;     /* æ»¿å¯¬ */
                height: 35vh;    /* é«˜åº¦åªä½”è¢å¹• 35% */
                border-radius: 15px 15px 0 0; /* ä¸Šæ–¹åœ“è§’ */
                border-left: none;
                border-top: 4px solid #00ffea; /* æ”¹æˆä¸Šæ–¹äº®æ¢ */
                box-sizing: border-box; /* ç¢ºä¿å…§è·ä¸æ’å¤§å¯¬åº¦ */
            }

            /* ç•¶é¢æ¿è¢«ã€Œæ”¶èµ·ã€æ™‚çš„æ¨£å¼ */
            #chat-panel.minimized {
                height: 45px; /* åªç•™æ¨™é¡Œçš„é«˜åº¦ */
                overflow: hidden;
            }
            
            /* æ‰‹æ©Ÿä¸Šå­—é«”ç¨å¾®èª¿å¤§ä¸€é»é»å¥½é»æ“Š */
            #panel-title { font-size: 14px; }
            #toggle-icon { display: block; } /* é¡¯ç¤ºæ”¶åˆæŒ‰éˆ• */
        }
    </style>
</head>
<body>

    <div id="world-map"></div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸŒ å…¨çƒè¨Šè™Ÿç«™ <span id="gps-status" class="gps-info" style="display:inline; margin-left:5px;">(å®šä½ä¸­...)</span></div>
            <div id="toggle-icon">æ”¶èµ· â–¼</div>
        </div>

        <div id="profile-section">
            <div class="input-group">
                <input type="text" id="name-input" placeholder="åå­—">
                <button id="update-name-btn">æ”¹å</button>
            </div>
        </div>

        <div id="chat-history">
            <div class="msg-sys">ç³»çµ±é€£ç·šä¸­...</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        // --- æ‰‹æ©Ÿç‰ˆæ”¶åˆåŠŸèƒ½ ---
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            var icon = document.getElementById('toggle-icon');
            
            if (isMinimized) {
                // å±•é–‹
                panel.classList.remove('minimized');
                icon.innerText = "æ”¶èµ· â–¼";
                isMinimized = false;
            } else {
                // æ”¶èµ·
                panel.classList.add('minimized');
                icon.innerText = "å±•é–‹ â–²";
                isMinimized = true;
            }
        }
        // -------------------

        var map = L.map('world-map', {
            minZoom: 2,
            maxBounds: [[-90, -180], [90, 180]], 
            maxBoundsViscosity: 1.0,
            zoomControl: false // æ‰‹æ©Ÿç‰ˆå…ˆæŠŠç¸®æ”¾æŒ‰éˆ•è—èµ·ä¾†ï¼Œé¿å…æ“‹è·¯ï¼Œç”¨æ‰‹æŒ‡ç¸®æ”¾å³å¯
        }).setView([20, 0], 2);

        // å¦‚æœæ˜¯é›»è…¦ç‰ˆï¼Œå†æŠŠç¸®æ”¾æŒ‰éˆ•åŠ å›ä¾†ï¼Œæ”¾åœ¨å³ä¸Šè§’
        if (window.innerWidth > 768) {
            L.control.zoom({ position: 'topright' }).addTo(map);
        }

        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Maps',
            maxZoom: 20, noWrap: true, bounds: [[-90, -180], [90, 180]]
        }).addTo(map);

        var markers = {};
        var accuracyCircle = null;
        var firstLoad = true;

        window.onload = function() {
            if (navigator.geolocation) {
                var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.watchPosition(
                    (pos) => { 
                        var lat = pos.coords.latitude;
                        var lng = pos.coords.longitude;
                        var accuracy = pos.coords.accuracy;

                        // æ›´æ–°æ¨™é¡Œåˆ—ä¸Šçš„ GPS ç‹€æ…‹ (ç°¡çŸ­ç‰ˆ)
                        document.getElementById('gps-status').innerText = `(èª¤å·®${Math.round(accuracy)}m)`;
                        
                        if (accuracyCircle) {
                            accuracyCircle.setLatLng([lat, lng]);
                            accuracyCircle.setRadius(accuracy);
                        } else {
                            accuracyCircle = L.circle([lat, lng], {
                                color: '#007bff', fillColor: '#007bff', fillOpacity: 0.1, radius: accuracy
                            }).addTo(map);
                        }

                        if (firstLoad) {
                            initConnection(lat, lng);
                            map.fitBounds(accuracyCircle.getBounds());
                            firstLoad = false;
                        } else {
                            socket.emit('playerMove', { lat: lat, lng: lng });
                        }
                    },
                    (err) => { 
                        document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)";
                        if(firstLoad) {
                            initConnection(20 + Math.random()*10, 120 + Math.random()*10);
                            firstLoad = false;
                        }
                    },
                    options
                );
            } else {
                initConnection(25.03, 121.56);
            }
        };

        function initConnection(lat, lng) {
            socket.emit('reportLocation', { lat: lat, lng: lng });
            addSystemMsg("é€£ç·šæˆåŠŸ");
        }

        socket.on('yourNameIs', function(name) {
            document.getElementById('name-input').value = name;
        });

        socket.on('history', function(historyMessages) {
            historyMessages.forEach(function(data) {
                if (data.isSystem) addSystemMsg(data.text);
                else addUserMsg(data.name, data.text);
            });
            var box = document.getElementById('chat-history');
            box.scrollTop = box.scrollHeight;
        });

        function updateName() {
            var newName = document.getElementById('name-input').value;
            if (newName.trim() !== "") {
                socket.emit('changeName', newName);
            }
        }
        document.getElementById('update-name-btn').addEventListener('click', updateName);

        map.on('click', function(e) {
            socket.emit('playerMove', { lat: e.latlng.lat, lng: e.latlng.lng });
            map.panTo(e.latlng);
            if(accuracyCircle) {
                accuracyCircle.setLatLng(e.latlng);
                accuracyCircle.setRadius(5); 
            }
        });

        socket.on('updateMap', function(allUsers) {
            for(var id in markers) { map.removeLayer(markers[id]); }
            markers = {};
            for (var id in allUsers) {
                var u = allUsers[id];
                var marker = L.marker([u.lat, u.lng]).addTo(map);
                marker.bindTooltip(u.name, { 
                    permanent: true, direction: 'top', className: 'user-label', offset: [0, -40]
                });
                markers[id] = marker;
            }
        });

        socket.on('chatMessage', function(data) {
            if (data.isSystem) {
                addSystemMsg(data.text);
            } else {
                addUserMsg(data.name, data.text);
                if (markers[data.id]) {
                    markers[data.id].bindPopup(data.text).openPopup();
                    setTimeout(() => { if(markers[data.id]) markers[data.id].closePopup(); }, 3000);
                }
            }
        });

        function addSystemMsg(text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `<div class="msg msg-sys">${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function addUserMsg(name, text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `
                <div class="msg">
                    <span class="msg-name">${name}:</span> 
                    <span class="msg-text">${text}</span>
                </div>`;
            box.scrollTop = box.scrollHeight;
        }

        var input = document.getElementById('msg-input');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                socket.emit('sendChat', input.value);
                input.value = "";
            }
        });
        
        // é˜²æ­¢æ‰‹æ©Ÿéµç›¤å½ˆå‡ºæ™‚ç•«é¢è·‘ç‰ˆ
        input.addEventListener('focus', function() {
            if (window.innerWidth <= 768) {
                // æ‰‹æ©Ÿæ‰“å­—æ™‚ï¼Œç¨å¾®æŠŠå°è©±æ¡†æ‹‰é«˜ä¸€é»ï¼Œé¿å…è¢«éµç›¤æ“‹ä½
                document.getElementById('chat-panel').style.height = '50vh';
            }
        });
        input.addEventListener('blur', function() {
            if (window.innerWidth <= 768 && !isMinimized) {
                document.getElementById('chat-panel').style.height = '35vh';
            }
        });
    </script>
</body>
</html>