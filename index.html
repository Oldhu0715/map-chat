<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨çƒå³æ™‚é€šè¨Š (æ­·å²ç´€éŒ„ç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #222; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #1a1a1a; }

        /* å·¦å´æ‡¸æµ®é¢æ¿ */
        #chat-panel {
            position: fixed; top: 20px; left: 20px;
            width: 320px; height: 60vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 15px;
            color: #ddd;
            display: flex; flex-direction: column;
            z-index: 1000;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 234, 0.2);
        }

        #profile-section { border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 10px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        #name-input { flex: 1; padding: 5px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; }
        #update-name-btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; }

        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 14px; }
        .msg { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .msg-name { color: #00ffea; font-weight: bold; font-size: 13px; }
        .msg-text { color: white; margin-top: 2px; }
        .msg-sys { color: #888; font-style: italic; font-size: 12px; }

        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 10px; border: none; border-radius: 4px; background: #333; color: white; }
        
        /* åå­—æ¨™ç±¤èˆ‡æ°£æ³¡ */
        .user-label {
            background-color: #000000; color: #00ffea; border: 2px solid #00ffea;
            font-size: 13px; font-weight: 900; padding: 3px 8px; border-radius: 4px;
            white-space: nowrap; box-shadow: 0 0 5px #00ffea; text-align: center;
        }
        .leaflet-popup-content-wrapper { background: rgba(0,0,0,0.9); color: white; border: 1px solid #00ffea; }
        .leaflet-popup-tip { background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>

    <div id="world-map"></div>

    <div id="chat-panel">
        <div style="font-size: 18px; font-weight: bold; color: white; margin-bottom: 5px;">
            ğŸŒ å…¨çƒè¨Šè™Ÿç«™
        </div>

        <div id="profile-section">
            <div style="font-size: 12px; color: #aaa;">æˆ‘çš„åå­—ï¼š</div>
            <div class="input-group">
                <input type="text" id="name-input" placeholder="è¼¸å…¥æ–°åå­—...">
                <button id="update-name-btn">æ”¹å</button>
            </div>
        </div>

        <div id="chat-history">
            <div class="msg-sys">æ­£åœ¨é€£çµé€šè¨Šè¡›æ˜Ÿ...</div>
        </div>
        
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="ç™¼é€å»£æ’­..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var map = L.map('world-map').setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', maxZoom: 19
        }).addTo(map);

        var markers = {};

        window.onload = function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => { initConnection(pos.coords.latitude, pos.coords.longitude); },
                    (err) => { 
                        addSystemMsg("ç„¡æ³•å–å¾—ä½ç½®ï¼Œåˆ‡æ›è‡³éš¨æ©Ÿåº§æ¨™ã€‚");
                        initConnection(20 + Math.random()*10, 120 + Math.random()*10);
                    }
                );
            } else {
                addSystemMsg("ç€è¦½å™¨ä¸æ”¯æ´å®šä½ã€‚");
                initConnection(25.03, 121.56);
            }
        };

        function initConnection(lat, lng) {
            map.setView([lat, lng], 13);
            socket.emit('reportLocation', { lat: lat, lng: lng });
            addSystemMsg("é€£ç·šæˆåŠŸã€‚");
        }

        socket.on('yourNameIs', function(name) {
            document.getElementById('name-input').value = name;
        });

        // --- 1. æ–°å¢ï¼šæ¥æ”¶æ­·å²è¨Šæ¯ ---
        socket.on('history', function(historyMessages) {
            // æŠŠæ”¶åˆ°çš„æ­·å²è¨Šæ¯ä¸€æ¢ä¸€æ¢é¡¯ç¤ºå‡ºä¾†
            historyMessages.forEach(function(data) {
                if (data.isSystem) {
                    addSystemMsg(data.text);
                } else {
                    addUserMsg(data.name, data.text);
                }
            });
            // æ²å‹•åˆ°åº•éƒ¨
            var box = document.getElementById('chat-history');
            box.scrollTop = box.scrollHeight;
        });
        // --------------------------

        function updateName() {
            var newName = document.getElementById('name-input').value;
            if (newName.trim() !== "") {
                socket.emit('changeName', newName);
            }
        }
        document.getElementById('update-name-btn').addEventListener('click', updateName);
        document.getElementById('name-input').addEventListener('keypress', (e) => { if(e.key==='Enter') updateName(); });

        map.on('click', function(e) {
            socket.emit('playerMove', { lat: e.latlng.lat, lng: e.latlng.lng });
            map.panTo(e.latlng);
        });

        socket.on('updateMap', function(allUsers) {
            for(var id in markers) { map.removeLayer(markers[id]); }
            markers = {};
            for (var id in allUsers) {
                var u = allUsers[id];
                var marker = L.marker([u.lat, u.lng]).addTo(map);
                marker.bindTooltip(u.name, { 
                    permanent: true, direction: 'top', className: 'user-label', offset: [0, -40]
                });
                markers[id] = marker;
            }
        });

        socket.on('chatMessage', function(data) {
            if (data.isSystem) {
                addSystemMsg(data.text);
            } else {
                addUserMsg(data.name, data.text);
                if (markers[data.id]) {
                    markers[data.id].bindPopup(data.text).openPopup();
                    setTimeout(() => { if(markers[data.id]) markers[data.id].closePopup(); }, 3000);
                }
            }
        });

        function addSystemMsg(text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `<div class="msg msg-sys">${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function addUserMsg(name, text) {
            var box = document.getElementById('chat-history');
            box.innerHTML += `
                <div class="msg">
                    <span class="msg-name">${name}:</span> 
                    <span class="msg-text">${text}</span>
                </div>`;
            box.scrollTop = box.scrollHeight;
        }

        var input = document.getElementById('msg-input');
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                socket.emit('sendChat', input.value);
                input.value = "";
            }
        });
    </script>
</body>
</html>