<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Radio Garden 2D (è‡ªè¨‚é ­åƒç‰ˆ)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; font-family: "Segoe UI", sans-serif; background: #222; overflow: hidden; }
        #world-map { height: 100vh; width: 100%; background: #222; }

        /* 1. æ’­æ”¾å™¨ */
        #radio-player-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: auto; min-height: 70px;
            background: rgba(10, 20, 15, 0.95);
            border-bottom: 2px solid #00ffaa;
            display: flex; flex-direction: column; 
            padding: 10px; box-sizing: border-box;
            z-index: 3000; color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .player-row-1 { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 8px; }
        .station-info { display: flex; flex-direction: column; max-width: 40%; overflow: hidden; }
        .station-name { font-weight: bold; font-size: 15px; color: #00ffaa; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 5px rgba(0,255,170,0.5); }
        .station-country { font-size: 11px; color: #aaa; }
        
        .custom-controls { display: flex; align-items: center; gap: 15px; flex: 1; justify-content: flex-end; }
        #play-pause-btn {
            background: none; border: 2px solid #00ffaa; color: #00ffaa;
            width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        #play-pause-btn:hover { background: #00ffaa; color: black; }

        .volume-container { display: flex; align-items: center; gap: 8px; width: 120px; }
        .volume-icon { font-size: 14px; color: #ccc; width: 15px; text-align: center; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { height: 14px; width: 14px; border-radius: 50%; background: #00ffaa; -webkit-appearance: none; margin-top: -5px; box-shadow: 0 0 5px #00ffaa; }
        audio { display: none; }

        .country-buttons { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; width: 100%; scrollbar-width: none; }
        .c-btn { background: #222; border: 1px solid #444; color: #ddd; padding: 4px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .c-btn:hover { background: #333; border-color: #00ffaa; color: white; }

        #loading-badge { position: fixed; bottom: 90px; right: 20px; background: rgba(0,0,0,0.8); color: #00ffaa; padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 3000; border: 1px solid #00ffaa; }

        /* 2. èŠå¤©é¢æ¿ (å«å€‹äººè³‡æ–™è¨­å®š) */
        #chat-panel {
            position: fixed; top: 110px; left: 20px; width: 320px; height: 50vh;
            background: rgba(0, 0, 0, 0.85);
            border-left: 4px solid #00ffea;
            padding: 10px; color: #ddd;
            display: flex; flex-direction: column;
            z-index: 2000; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        #chat-panel.minimized { height: 45px; overflow: hidden; }
        #panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer; padding-bottom: 5px; border-bottom: 1px solid #444; }
        #panel-title { font-size: 16px; font-weight: bold; color: white; }
        
        /* å€‹äººè³‡æ–™è¨­å®šå€ */
        #profile-section { padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #333; }
        .input-row { display: flex; gap: 5px; margin-bottom: 5px; }
        input.dark-input { flex: 1; padding: 6px; background: #333; border: 1px solid #555; color: #00ffea; font-weight: bold; font-size: 12px; border-radius: 4px; }
        input.dark-input::placeholder { color: #666; }
        #update-btn { background: #007bff; color: white; border: none; padding: 0 10px; cursor: pointer; font-size: 12px; border-radius: 4px; white-space: nowrap;}
        
        #chat-history { flex: 1; overflow-y: auto; margin-bottom: 5px; font-size: 13px; }
        .msg { margin-bottom: 6px; padding-bottom: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: flex-start; gap: 8px; }
        .msg-avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #333; border: 1px solid #00ffea; }
        .msg-content { flex: 1; }
        .msg-name { color: #00ffea; font-weight: bold; font-size: 12px; }
        .msg-text { color: white; word-break: break-all; }
        .msg-sys { color: #aaa; font-style: italic; font-size: 11px; }
        
        #input-area { display: flex; gap: 5px; }
        #msg-input { flex: 1; padding: 8px; border: none; border-radius: 4px; background: #333; color: white; font-size: 14px; }

        /* 3. åœ°åœ–æ¨™è¨˜æ¨£å¼ */
        .radio-dot { background-color: #00ffaa; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px #00ffaa; }
        .radio-label { background-color: rgba(0, 20, 10, 0.9); color: #00ffaa; border: 1px solid #00ffaa; font-size: 11px; padding: 2px 5px; border-radius: 4px; }
        
        /* ç©å®¶å¤§é ­ç…§æ¨£å¼ */
        .user-avatar-marker {
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 2px solid #00ffea;
            box-shadow: 0 0 10px #00ffea;
            object-fit: cover;
            background: #000;
        }
        .user-label { background-color: black; color: #00ffea; border: 1px solid #00ffea; font-size: 12px; font-weight: bold; padding: 2px 6px; border-radius: 4px; text-align: center; white-space: nowrap;}

        /* èšåˆç¾¤çµ„ */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(0, 255, 170, 0.4); }
        .marker-cluster div { background-color: rgba(0, 20, 10, 0.9); color: #00ffaa; font-weight: bold; border: 1px solid #00ffaa; border-radius: 50%; }

        @media (max-width: 768px) {
            #chat-panel { top: auto; left: 0; bottom: 0; width: 100%; height: 40vh; border-radius: 15px 15px 0 0; border-left: none; border-top: 4px solid #00ffea; }
            #chat-panel.minimized { height: 45px; overflow: hidden; }
            #radio-player-bar { height: auto; }
            .volume-container { width: 80px; }
        }
    </style>
</head>
<body>

    <div id="radio-player-bar">
        <div class="player-row-1">
            <div class="station-info">
                <div class="station-name" id="current-station">è«‹é¸æ“‡é›»å°</div>
                <div class="station-country" id="current-country">æº–å‚™å°±ç·’</div>
            </div>
            <div class="custom-controls">
                <button id="play-pause-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                <div class="volume-container">
                    <i class="fas fa-volume-up volume-icon" id="vol-icon"></i>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
                </div>
            </div>
            <audio id="audio-player" playsinline></audio>
        </div>
        <div class="country-buttons">
            <button class="c-btn" onclick="loadByCountry('TW', 'å°ç£', [23.6, 121])">ğŸ‡¹ğŸ‡¼ å°ç£</button>
            <button class="c-btn" onclick="loadByCountry('JP', 'æ—¥æœ¬', [36, 138])">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</button>
            <button class="c-btn" onclick="loadByCountry('US', 'ç¾åœ‹', [37, -95])">ğŸ‡ºğŸ‡¸ ç¾åœ‹</button>
            <button class="c-btn" onclick="loadByCountry('CN', 'ä¸­åœ‹', [35, 104])">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</button>
            <button class="c-btn" onclick="loadByCountry('HK', 'é¦™æ¸¯', [22.3, 114.1])">ğŸ‡­ğŸ‡° é¦™æ¸¯</button>
            <button class="c-btn" onclick="loadStationsInView(true)">ğŸŒ æœå°‹ç›®å‰åœ°åœ–</button>
        </div>
    </div>

    <div id="loading-badge">ğŸ“¡ æ­£åœ¨å¾è³‡æ–™åº«æ’ˆå–...</div>
    <div id="world-map"></div>

    <div id="chat-panel">
        <div id="panel-header" onclick="togglePanel()">
            <div id="panel-title">ğŸŒ å…¨çƒè¨Šè™Ÿç«™</div>
            <div id="toggle-icon">æ”¶èµ· â–¼</div>
        </div>
        
        <div id="profile-section">
            <div class="input-row">
                <input type="text" id="name-input" class="dark-input" placeholder="ä½ çš„åå­—">
            </div>
            <div class="input-row">
                <input type="text" id="avatar-input" class="dark-input" placeholder="å¤§é ­è²¼åœ–ç‰‡ç¶²å€ (https://...)">
                <button id="update-btn" onclick="updateProfile()">æ›´æ–°è³‡æ–™</button>
            </div>
        </div>

        <div id="chat-history">
            <div class="msg msg-sys">ç³»çµ±é€£ç·šä¸­...</div>
            <div class="msg msg-sys" style="color: #ff0055;">â˜… æç¤ºï¼šè²¼ä¸Šåœ–ç‰‡ç¶²å€å¯è¨­å®šå¤§é ­è²¼ï¼</div>
        </div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        
        // --- éŸ³é‡èˆ‡æ’­æ”¾æ§åˆ¶ ---
        const audioPlayer = document.getElementById('audio-player');
        const playBtn = document.getElementById('play-pause-btn');
        const volSlider = document.getElementById('volume-slider');
        const volIcon = document.getElementById('vol-icon');

        volSlider.addEventListener('input', function(e) {
            const vol = e.target.value;
            audioPlayer.volume = vol;
            if(vol == 0) volIcon.className = "fas fa-volume-mute volume-icon";
            else if(vol < 0.5) volIcon.className = "fas fa-volume-down volume-icon";
            else volIcon.className = "fas fa-volume-up volume-icon";
        });

        function togglePlay() {
            if (audioPlayer.paused) { audioPlayer.play().catch(e => console.log("error")); } 
            else { audioPlayer.pause(); }
        }
        audioPlayer.onplay = function() { playBtn.innerHTML = '<i class="fas fa-pause"></i>'; };
        audioPlayer.onpause = function() { playBtn.innerHTML = '<i class="fas fa-play"></i>'; };

        // --- é¢æ¿æ§åˆ¶ ---
        var isMinimized = false;
        function togglePanel() {
            var panel = document.getElementById('chat-panel');
            var icon = document.getElementById('toggle-icon');
            if (isMinimized) { panel.classList.remove('minimized'); icon.innerText = "æ”¶èµ· â–¼"; isMinimized = false; } 
            else { panel.classList.add('minimized'); icon.innerText = "å±•é–‹ â–²"; isMinimized = true; }
        }

        // --- åœ°åœ–åˆå§‹åŒ– ---
        var map = L.map('world-map', {
            minZoom: 2, maxBounds: [[-90, -180], [90, 180]], maxBoundsViscosity: 1.0, zoomControl: false 
        }).setView([23.6, 121], 7);

        if (window.innerWidth > 768) L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            attribution: '&copy; Google Maps', maxZoom: 20, noWrap: true, bounds: [[-90, -180], [90, 180]]
        }).addTo(map);

        var markers = {};
        var accuracyCircle = null;
        var firstLoad = true;
        var loadedStationIds = new Set();
        var radioCluster = L.markerClusterGroup({ maxClusterRadius: 50, disableClusteringAtZoom: 13 });
        map.addLayer(radioCluster);

        var radioIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ff0055;width:24px;height:24px;border-radius:50%;display:flex;justify-content:center;align-items:center;border:2px solid white;box-shadow:0 0 5px black;font-size:12px;'>ğŸµ</div>",
            iconSize: [24, 24], iconAnchor: [12, 12]
        });

        // --- é›»å°è¼‰å…¥é‚è¼¯ ---
        function loadByCountry(code, name, latlng) {
            document.getElementById('loading-badge').style.display = 'block';
            document.getElementById('current-country').innerText = `æ­£åœ¨ä¸‹è¼‰ ${name} é›»å°...`;
            if (latlng) map.setView(latlng, 7);
            radioCluster.clearLayers(); loadedStationIds.clear();

            var servers = ['de1', 'fr1', 'at1'];
            var server = servers[Math.floor(Math.random() * servers.length)];
            
            fetch(`https://${server}.api.radio-browser.info/json/stations/bycountrycodeexact/${code}?hidebroken=true&limit=300`)
            .then(res => res.json())
            .then(stations => {
                addStationsToMap(stations, latlng); 
                document.getElementById('loading-badge').style.display = 'none';
                document.getElementById('current-country').innerText = `å·²è¼‰å…¥ ${stations.length} å€‹ ${name} é›»å°`;
            })
            .catch(err => { document.getElementById('loading-badge').style.display = 'none'; });
        }

        function loadStationsInView(isForce) {
            var bounds = map.getBounds();
            document.getElementById('loading-badge').style.display = 'block';
            if(isForce) { radioCluster.clearLayers(); loadedStationIds.clear(); }

            fetch(`https://de1.api.radio-browser.info/json/stations/search?limit=300&hidebroken=true&lat_min=${bounds.getSouth()}&lat_max=${bounds.getNorth()}&long_min=${bounds.getWest()}&long_max=${bounds.getEast()}`)
            .then(res => res.json())
            .then(stations => {
                addStationsToMap(stations);
                document.getElementById('loading-badge').style.display = 'none';
                document.getElementById('current-country').innerText = `åœ°åœ–ç¯„åœå…§ç™¼ç¾ ${stations.length} å€‹é›»å°`;
            })
            .catch(err => { document.getElementById('loading-badge').style.display = 'none'; });
        }

        function addStationsToMap(stations, defaultLatLng) {
            stations.forEach(station => {
                if (!loadedStationIds.has(station.stationuuid)) {
                    var lat = station.geo_lat;
                    var lng = station.geo_long;
                    if ((!lat || !lng) && defaultLatLng) {
                        lat = defaultLatLng[0] + (Math.random() - 0.5) * 2;
                        lng = defaultLatLng[1] + (Math.random() - 0.5) * 2;
                    }
                    if (lat && lng) {
                        var marker = L.marker([lat, lng], {icon: radioIcon})
                            .bindTooltip(station.name, { direction: 'top', className: 'radio-label', offset: [0, -12] });
                        marker.on('click', function() { playRadio(station.name, station.country, station.url_resolved); });
                        radioCluster.addLayer(marker);
                        loadedStationIds.add(station.stationuuid);
                    }
                }
            });
        }

        function playRadio(name, country, url) {
            var nameDisplay = document.getElementById('current-station');
            var countryDisplay = document.getElementById('current-country');
            var finalUrl = url;
            if (url.startsWith('http://')) { finalUrl = '/radio-proxy?url=' + encodeURIComponent(url); }

            audioPlayer.src = finalUrl;
            nameDisplay.innerText = "ç·©è¡ä¸­... " + name;
            audioPlayer.play().then(() => {
                nameDisplay.innerText = "ğŸµ " + name;
                countryDisplay.innerText = country;
            }).catch(e => {
                nameDisplay.innerText = "âŒ ç„¡æ³•æ’­æ”¾";
                countryDisplay.innerText = "è¨Šè™Ÿæºç„¡å›æ‡‰";
            });
        }

        // --- ä½¿ç”¨è€…èˆ‡é ­åƒé‚è¼¯ ---
        var myAvatar = ""; // å„²å­˜è‡ªå·±çš„é ­åƒç¶²å€

        window.onload = function() {
            // é è¨­è¼‰å…¥å°ç£
            setTimeout(() => loadByCountry('TW', 'å°ç£', [23.6, 121]), 1000);

            if (navigator.geolocation) {
                var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
                navigator.geolocation.watchPosition(
                    (pos) => { 
                        var lat = pos.coords.latitude, lng = pos.coords.longitude, acc = pos.coords.accuracy;
                        document.getElementById('gps-status').innerText = `(èª¤å·®${Math.round(acc)}m)`;
                        
                        // ç•«èª¤å·®åœˆ
                        if (accuracyCircle) { accuracyCircle.setLatLng([lat, lng]); accuracyCircle.setRadius(acc); } 
                        else { accuracyCircle = L.circle([lat, lng], { color: '#007bff', fillColor: '#007bff', fillOpacity: 0.1, radius: acc }).addTo(map); }
                        
                        // ç¬¬ä¸€æ¬¡å®šä½
                        if (firstLoad) { 
                            // é€™è£¡å‚³å…¥ myAvatar
                            socket.emit('reportLocation', { lat: lat, lng: lng, avatar: myAvatar }); 
                            addSystemMsg("é€£ç·šæˆåŠŸ");
                            firstLoad = false; 
                        } else { 
                            socket.emit('playerMove', { lat: lat, lng: lng }); 
                        }
                    },
                    (err) => { document.getElementById('gps-status').innerText = "(ç„¡è¨Šè™Ÿ)"; if(firstLoad){ socket.emit('reportLocation', { lat: 25.03, lng: 121.56, avatar: "" }); firstLoad=false; } },
                    options
                );
            } else { socket.emit('reportLocation', { lat: 25.03, lng: 121.56, avatar: "" }); }
        };

        socket.on('yourNameIs', function(name) { document.getElementById('name-input').value = name; });
        
        socket.on('history', function(h) { 
            var b = document.getElementById('chat-history');
            h.forEach(d => {
                // å¦‚æœæœ‰é ­åƒï¼Œé¡¯ç¤ºåœ–ç‰‡ï¼›æ²’æœ‰å°±é¡¯ç¤ºç³»çµ±é è¨­
                var avatarHtml = d.isSystem ? '' : (d.avatar ? `<img src="${d.avatar}" class="msg-avatar">` : `<div class="msg-avatar" style="background:#555"></div>`);
                
                b.innerHTML += `<div class="msg">
                    ${avatarHtml}
                    <div class="msg-content">
                        <span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}</span>
                        <span class="${d.isSystem?'msg-sys':'msg-text'}">${d.text}</span>
                    </div>
                </div>`;
            });
            b.scrollTop = b.scrollHeight;
        });

        // æ›´æ–°å€‹äººè³‡æ–™ (åå­— + é ­åƒ)
        function updateProfile() { 
            var n = document.getElementById('name-input').value; 
            var a = document.getElementById('avatar-input').value;
            myAvatar = a; // è¨˜ä½è‡ªå·±çš„é ­åƒ
            socket.emit('updateProfile', { name: n, avatar: a }); 
        }

        map.on('click', function(e) { socket.emit('playerMove', { lat: e.latlng.lat, lng: e.latlng.lng }); map.panTo(e.latlng); if(accuracyCircle){ accuracyCircle.setLatLng(e.latlng); accuracyCircle.setRadius(5); } });

        // æ›´æ–°åœ°åœ–ä¸Šçš„ç©å®¶ (å«å¤§é ­ç…§)
        socket.on('updateMap', function(u) { 
            for(var i in markers) map.removeLayer(markers[i]); 
            markers={}; 
            for(var i in u) { 
                var user = u[i];
                var icon;
                
                // å¦‚æœæœ‰é ­åƒï¼Œç”¨åœ–ç‰‡ç•¶ Icon
                if (user.avatar && user.avatar.trim() !== "") {
                    icon = L.divIcon({
                        className: 'custom-user-icon',
                        html: `<img src="${user.avatar}" class="user-avatar-marker">`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });
                } else {
                    // æ²’é ­åƒï¼Œç”¨è—è‰²åœ“é»
                    icon = L.divIcon({
                        className: 'custom-user-icon',
                        html: `<div style="width:12px;height:12px;background:#00ffea;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #00ffea;"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                }

                var m = L.marker([user.lat, user.lng], {icon: icon}).addTo(map); 
                m.bindTooltip(user.name, { permanent:true, direction:'top', className:'user-label', offset:[0, -25] }); 
                markers[i]=m; 
            } 
        });

        socket.on('chatMessage', function(d) { 
             var b = document.getElementById('chat-history');
             var avatarHtml = d.isSystem ? '' : (d.avatar ? `<img src="${d.avatar}" class="msg-avatar">` : `<div class="msg-avatar" style="background:#555"></div>`);
             
             b.innerHTML += `<div class="msg">
                ${avatarHtml}
                <div class="msg-content">
                    <span class="${d.isSystem?'msg-sys':'msg-name'}">${d.isSystem?'':d.name+': '}</span>
                    <span class="${d.isSystem?'msg-sys':'msg-text'}">${d.text}</span>
                </div>
            </div>`;
             b.scrollTop = b.scrollHeight;
        });
        
        function addSystemMsg(t) { 
            var b=document.getElementById('chat-history'); 
            b.innerHTML+=`<div class="msg"><div class="msg-content"><span class="msg-sys">${t}</span></div></div>`; 
            b.scrollTop=b.scrollHeight; 
        }

        var input=document.getElementById('msg-input'); 
        input.addEventListener('keypress', function(e){ if(e.key==='Enter'&&input.value.trim()){ socket.emit('sendChat', input.value); input.value=""; } });
        
        input.addEventListener('focus', function(){ if(window.innerWidth<=768) document.getElementById('chat-panel').style.height='50vh'; });
        input.addEventListener('blur', function(){ if(window.innerWidth<=768&&!isMinimized) document.getElementById('chat-panel').style.height='35vh'; });
    </script>
</body>
</html>